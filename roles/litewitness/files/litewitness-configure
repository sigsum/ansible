#!/bin/bash

#
# Managed by ansible -- do not edit.
#

set -eu

next_line() {
	while IFS= read -r line; do
		if [[ -z "$line" ]] || [[ "$line" =~ ^# ]]; then
			continue # Skip empty lines and comments
		fi

		echo "$line"
		return 0 # non-empty line
	done

	return 1 # EOF
}

db_file=$1; shift
config_file=$1; shift
config_file_non_sigsum_logs=$1; shift
config_file_per_log_bastions=$1; shift

witnessctl=~/go/bin/witnessctl
log_file=$(dirname "$db_file")/.litewitness-configure.tmp

dup_str="UNIQUE constraint failed:"

trap clean_up EXIT
function clean_up() {
    rm -f "$log_file"
}

# Add sigsum logs
while IFS= read -r line; do
	if [[ -z "$line" ]] || [[ "$line" =~ ^# ]]; then
		continue # Skip empty lines and comments
	fi

	"$witnessctl" add-sigsum-log -db "$db_file" -key "$line" 2> "$log_file" ||
		grep -q "$dup_str" "$log_file" ||
		(cat "$log_file"; exit 1)
done < "$config_file"

# Add non-sigsum logs
while IFS= read -r line; do
	if [[ -z "$line" ]] || [[ "$line" =~ ^# ]]; then
		continue # Skip empty lines and comments
	fi

	# line is expected to contain a vkey followed by an origin string
	vkey=$(echo "$line" | cut -d' ' -f1)
	origin=$(echo "$line" | cut -d' ' -f2-)
	# Invoke witnessctl twice, first with add-log and then with add-key
	"$witnessctl" add-log -db "$db_file" -origin "$origin" 2> "$log_file" ||
		grep -q "$dup_str" "$log_file" ||
		(cat "$log_file"; exit 1)
	"$witnessctl" add-key -db "$db_file" -origin "$origin" -key "$vkey" 2> "$log_file" ||
		grep -q "$dup_str" "$log_file" ||
		(cat "$log_file"; exit 1)
done < "$config_file_non_sigsum_logs"

# Update per-log bastions
changed=false
while true; do
	if ! origin=$(next_line); then
		break # EOF
	fi
	if ! bastions=$(next_line); then
		echo "fatal: expected per-log bastion host(s) for log with origin \"$origin\"" >&2
		exit 1
	fi

	logs_json=$("$witnessctl" list-logs -db "$db_file")

	if ! jq -e -s --arg o "$origin" 'any(.[]; .origin == $o)' >/dev/null <<< "$logs_json"; then
		echo "fatal: origin \"$origin\" not found in database" >&2
		exit 1
	fi

	read -a desired_bastions <<< "$bastions"
	mapfile -t actual_bastions < <(
		jq -r --arg o "$origin" 'select(.origin == $o) | .bastions[]?' <<< "$logs_json"
	)

	for ab in "${actual_bastions[@]}"; do
		found=false
		for db in "${desired_bastions[@]}"; do
			if [[ "$ab" == "$db" ]]; then
				found=true
				break
			fi
		done

		if [[ $found == false ]]; then
			"$witnessctl" del-bastion -db "$db_file" -origin "$origin" -bastion "$ab"
			changed=true
		fi
	done

	for db in "${desired_bastions[@]}"; do
		if ! printf "%s\n" "${actual_bastions[@]}" | grep -Fxq "$db"; then
			"$witnessctl" add-bastion -db "$db_file" -origin "$origin" -bastion "$db"
			changed=true
		fi
	done
done < "$config_file_per_log_bastions"

if [[ $changed == true ]]; then
	# systemctl reload requires root; send SIGHUP directly.
	pid=$(/usr/bin/systemctl show --property MainPID --value "litewitness@$(id -un).service")
	[[ "$pid" -gt 0 ]] && /bin/kill -SIGHUP "$pid"
fi
